# プロキシローテーションテストガイド

このガイドでは、プロキシローテーション機能をテストし、IPアドレスの変更を確認する方法を説明します。

## 前提条件

- プロキシサービスのアカウントと認証情報が必要です
- iproyalなどのプロキシサービスを使用する場合、複数のプロキシエンドポイントが必要です

## テスト手順

### 1. .envファイルの作成

`.env.example`を参考に、`.env`ファイルを作成します：

```bash
cp .env.example .env
```

### 2. プロキシ設定の追加

`.env`ファイルを編集し、実際のプロキシ認証情報を設定します：

```bash
# プロキシを使用する
USE_PROXY=true

# 単一のプロキシを使用する場合
PROXY_URL=http://username:password@geo.iproyal.com:51200

# または、複数のプロキシをローテーションする場合
PROXY_URLS=http://user1:pass1@proxy1.com:8080,http://user2:pass2@proxy2.com:8080
PROXY_ROTATION=random  # または sequential

# プロキシをローテーションする間隔（ステップ数）
PROXY_ROTATION_INTERVAL=2  # 2ステップごとにプロキシを切り替え
```

**重要:** `.env`ファイルは`.gitignore`に含まれているため、機密情報がGitにコミットされることはありません。

### 3. テスト実行

プロキシローテーション機能をテストするには、以下のコマンドを実行します：

```bash
# プロキシローテーション間隔を2ステップに設定してテスト
MAX_STEPS=6 PROXY_ROTATION_INTERVAL=2 npm run dev
```

### 4. IPアドレスの確認

実行中に、以下のようなログが表示されます：

```
[INFO] === 初期IPアドレス === {"ip":"xxx.xxx.xxx.xxx"}
[INFO] プロキシをローテーションしました（ステップ: 2）
[INFO] 現在のIPアドレス: yyy.yyy.yyy.yyy
[INFO] ✅ IPアドレスの変更を確認しました {"step":2,"previousIP":"xxx.xxx.xxx.xxx","currentIP":"yyy.yyy.yyy.yyy"}
```

### 5. ログの確認ポイント

- **初期IPアドレス**: プログラム開始時のIPアドレス
- **プロキシローテーション**: プロキシが切り替わったタイミング
- **IPアドレスの変更確認**: IPが実際に変更されたかどうか

## テストスクリプトの使用

テスト用のスクリプトも用意されています：

```bash
./test-proxy-rotation.sh
```

このスクリプトは、`.env`ファイルの設定を確認し、プロキシローテーションテストを実行します。

## トラブルシューティング

### IPアドレスが変更されない場合

1. **プロキシ設定の確認**
   - `.env`ファイルで`USE_PROXY=true`が設定されているか確認
   - `PROXY_URL`または`PROXY_URLS`が正しく設定されているか確認

2. **プロキシ認証情報の確認**
   - ユーザー名とパスワードが正しいか確認
   - プロキシURLの形式が正しいか確認（`http://username:password@host:port`）

3. **プロキシサービスの確認**
   - プロキシサービスが正常に動作しているか確認
   - 複数のプロキシエンドポイントが利用可能か確認

4. **ログの確認**
   - プロキシのローテーションが実行されているか確認
   - エラーメッセージがないか確認

### プロキシ接続エラーが発生する場合

1. **ネットワーク接続の確認**
   - インターネット接続が正常か確認
   - プロキシサーバーにアクセスできるか確認

2. **プロキシ設定の形式確認**
   - URLの形式が正しいか確認
   - ポート番号が正しいか確認

3. **ファイアウォールの確認**
   - ファイアウォールがプロキシ接続をブロックしていないか確認

## 注意事項

- プロキシサービスによっては、IPアドレスの変更に時間がかかる場合があります
- 複数のプロキシを使用する場合、すべてのプロキシが正常に動作していることを確認してください
- プロキシローテーション間隔を短くしすぎると、プロキシサービスのレート制限に引っかかる可能性があります

